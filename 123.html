<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>迎賓暨賓客祝福系統 / Guest Welcome & Blessing System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Poppins:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', 'Noto Sans TC', sans-serif; background: linear-gradient(to bottom, #f0f2f5, #ffffff); color: #374151; overflow: hidden; position: relative; }
        .nav-btn, .lang-btn { background-color: #e5e7eb; color: #4b5563; transition: all 0.3s ease; }
        .nav-btn.active, .nav-btn:hover, .lang-btn.active, .lang-btn:hover { background-color: #005a9e; color: #ffffff; }
        .submit-btn { background: linear-gradient(145deg, #facc15, #eab308); color: #422006; transition: all 0.3s ease; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        .marquee-container { width: 100%; overflow: hidden; white-space: nowrap; box-sizing: border-box; display: flex; align-items: center; height: 25%; }
        .marquee-content { display: inline-block; padding-left: 100%; animation: marquee 60s linear infinite; }
        .marquee-container:hover .marquee-content { animation-play-state: paused; }
        .blessing-item { display: inline-flex; align-items: baseline; margin: 0 2rem; font-size: 1.5rem; color: #f59e0b; }
        .blessing-item .name { color: #4b5563; font-size: 1.1rem; margin-left: 0.75rem; white-space: nowrap; }
        .blessing-item .details { color: #6b7280; font-size: 0.9rem; margin-left: 0.5rem; white-space: nowrap; }
        @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
        .lantern-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; z-index: -1; }
        .lantern { position: absolute; bottom: -150px; background: #facc15; border-radius: 45% 45% 10% 10%; opacity: 0; animation: float-up 20s infinite linear; box-shadow: 0 0 20px #facc15, 0 0 30px #facc15; }
        .lantern::before { content: ''; position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%); width: 20px; height: 10px; background: #a16207; border-radius: 0 0 5px 5px; }
        .lantern.small { width: 30px; height: 36px; } .lantern.medium { width: 40px; height: 48px; } .lantern.large { width: 60px; height: 72px; }
        @keyframes float-up { 0% { transform: translateY(0); opacity: 0; } 10% { opacity: 0.7; } 90% { opacity: 0.7; } 100% { transform: translateY(-120vh) rotate(10deg); opacity: 0; } }
    </style>
</head>
<body class="w-full h-screen flex flex-col p-4 md:p-6 lg:p-8">

    <div class="lantern-container" id="lantern-container"></div>

    <header class="flex-shrink-0 flex flex-col md:flex-row justify-between items-center mb-4 z-10">
        <h1 id="event-title" class="text-2xl md:text-3xl lg:text-4xl font-bold text-[#005a9e] mb-4 md:mb-0 text-center md:text-left"></h1>
        <nav class="flex items-center space-x-2 md:space-x-4">
            <div class="flex space-x-2 rounded-lg p-1 bg-gray-200/80 backdrop-blur-sm">
                <button id="show-input-btn" data-lang-key="navInput" class="nav-btn px-4 py-2 text-sm md:text-base font-semibold rounded-md"></button>
                <button id="show-display-btn" data-lang-key="navDisplay" class="nav-btn px-4 py-2 text-sm md:text-base font-semibold rounded-md"></button>
            </div>
            <div class="flex items-center space-x-2 rounded-lg p-1 bg-gray-200/80 backdrop-blur-sm">
                <button id="lang-zh-btn" class="lang-btn px-3 py-2 text-sm md:text-base font-semibold rounded-md">中文</button>
                <button id="lang-en-btn" class="lang-btn px-3 py-2 text-sm md:text-base font-semibold rounded-md">EN</button>
            </div>
        </nav>
    </header>

    <main class="flex-grow w-full h-full overflow-hidden z-10">
        <section id="input-section" class="hidden w-full h-full flex items-center justify-center">
            <div class="w-full max-w-lg bg-white/80 backdrop-blur-sm border border-gray-200 p-8 rounded-2xl shadow-xl">
                <h2 data-lang-key="signInTitle" class="text-3xl font-bold text-center mb-6 text-[#005a9e]"></h2>
                <form id="guest-form" class="space-y-6">
                    <div>
                        <label for="name" data-lang-key="labelName" class="block text-sm font-medium text-gray-600 mb-1"></label>
                        <input type="text" id="name" name="name" required class="w-full bg-gray-100 border border-gray-300 text-gray-900 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#005a9e]">
                    </div>
                    <div>
                        <label for="organization" data-lang-key="labelSchool" class="block text-sm font-medium text-gray-600 mb-1"></label>
                        <input type="text" id="organization" name="organization" required class="w-full bg-gray-100 border border-gray-300 text-gray-900 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#005a9e]">
                    </div>
                    <div>
                        <label for="title" data-lang-key="labelTitle" class="block text-sm font-medium text-gray-600 mb-1"></label>
                        <input type="text" id="title" name="title" required class="w-full bg-gray-100 border border-gray-300 text-gray-900 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#005a9e]">
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <label for="blessing" data-lang-key="labelBlessing" class="block text-sm font-medium text-gray-600"></label>
                            <button type="button" id="generate-blessing-btn" class="text-sm text-[#005a9e] hover:text-[#f59e0b] font-semibold transition-colors duration-200 flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-magic mr-1" viewBox="0 0 16 16"><path d="M9.5 2.672a.5.5 0 1 0 1 0V.843a.5.5 0 0 0-1 0v1.829Zm4.5.035A.5.5 0 0 0 13.293 2L12 3.293a.5.5 0 1 0 .707.707L14 2.707a.5.5 0 0 0 0-.707ZM7.293 4L8 3.293a.5.5 0 1 0-.707-.707L6.586 3.586a.5.5 0 0 0 0 .707l.707.707a.5.5 0 0 0 .707 0Z"/><path d="M.5 10.025a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-1 0v-2.5h-2a.5.5 0 0 1-.5-.5Zm8.5-4.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-3Zm-4.5 7a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-2.5v2.5a.5.5 0 0 1-1 0v-3Z"/></svg>
                                <span data-lang-key="aiButton"></span>
                            </button>
                        </div>
                        <div class="relative">
                           <textarea id="blessing" name="blessing" rows="3" maxlength="50" required class="w-full bg-gray-100 border border-gray-300 text-gray-900 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-[#005a9e]"></textarea>
                           <div id="blessing-loader" class="absolute inset-0 bg-white/80 flex items-center justify-center rounded-lg hidden">
                                <svg class="animate-spin h-6 w-6 text-[#005a9e]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                <span data-lang-key="aiLoading" class="ml-2 text-gray-700"></span>
                            </div>
                        </div>
                    </div>
                    <button type="submit" data-lang-key="submitButton" class="submit-btn w-full font-bold py-3 px-4 rounded-lg text-lg"></button>
                </form>
            </div>
        </section>

        <section id="display-section" class="w-full h-full">
            <div id="blessing-wall" class="w-full h-full bg-white/60 backdrop-blur-sm border border-gray-200/50 rounded-2xl shadow-xl flex flex-col justify-around p-4 relative">
                <div id="blessing-placeholder" class="absolute inset-0 flex items-center justify-center text-center text-gray-500">
                    <p data-lang-key="blessingPlaceholder" class="text-2xl"></p>
                </div>
                <div class="marquee-container"><div class="marquee-content" id="marquee-content-1"></div></div>
                <div class="marquee-container"><div class="marquee-content" id="marquee-content-2"></div></div>
                <div class="marquee-container"><div class="marquee-content" id="marquee-content-3"></div></div>
                <div class="marquee-container"><div class="marquee-content" id="marquee-content-4"></div></div>
            </div>
        </section>

        <div id="toast" class="fixed bottom-10 right-10 bg-green-500 text-white py-3 px-6 rounded-lg shadow-xl text-lg opacity-0 transform translate-y-5 transition-all duration-500"></div>
    </main>
    
    <!-- 引入 Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBMDpfUenL-VTxkHrfZeBgVDMsvtPUoK9g",
            authDomain: "guest-blessing-system.firebaseapp.com",
            projectId: "guest-blessing-system",
            storageBucket: "guest-blessing-system.appspot.com",
            messagingSenderId: "953533576568",
            appId: "1:953533576568:web:923b2abff3a0060af4c48d",
            measurementId: "G-7KGHWGPPE9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        document.addEventListener('DOMContentLoaded', () => {
            const elements = {
                eventTitle: document.getElementById('event-title'),
                inputSection: document.getElementById('input-section'),
                displaySection: document.getElementById('display-section'),
                showInputBtn: document.getElementById('show-input-btn'),
                showDisplayBtn: document.getElementById('show-display-btn'),
                langZhBtn: document.getElementById('lang-zh-btn'),
                langEnBtn: document.getElementById('lang-en-btn'),
                guestForm: document.getElementById('guest-form'),
                marqueeContents: [
                    document.getElementById('marquee-content-1'),
                    document.getElementById('marquee-content-2'),
                    document.getElementById('marquee-content-3'),
                    document.getElementById('marquee-content-4')
                ],
                blessingPlaceholder: document.getElementById('blessing-placeholder'),
                toast: document.getElementById('toast'),
                lanternContainer: document.getElementById('lantern-container'),
                generateBlessingBtn: document.getElementById('generate-blessing-btn'),
                blessingTextarea: document.getElementById('blessing'),
                blessingLoader: document.getElementById('blessing-loader'),
            };

            const translations = {
                'zh-Hant': { eventTitleDefault: '2025桃園市國民小學中外師資培訓共識營', navInput: '簽到輸入', navDisplay: '祝福牆面', signInTitle: '貴賓簽到', labelName: '姓名', labelSchool: '服務學校', labelTitle: '職稱', labelBlessing: '祝福語 (50字以內)', submitButton: '簽到', blessingPlaceholder: '等待貴賓的祝福...', toastSuccess: '感謝您的祝福！簽到成功！', toastError: '請填寫所有欄位', aiButton: 'AI 幫我寫', aiLoading: '產生中...', toastAiError: 'AI祝福語產生失敗，請稍後再試', geminiPrompt: (title) => `你是一位參加「${title}」活動的貴賓。請以正體中文寫一句簡短、誠摯且正面的祝福語，風格高雅，字數請控制在50字以內。`, },
                'en': { eventTitleDefault: '2025 Taoyuan Elementary School Teacher Training Consensus Camp', navInput: 'Sign-In Form', navDisplay: 'Blessing Wall', signInTitle: 'Guest Sign-In', labelName: 'Name', labelSchool: 'School/Organization', labelTitle: 'Title', labelBlessing: 'Blessing (max 50 characters)', submitButton: 'Sign In', blessingPlaceholder: 'Waiting for guests\' blessings...', toastSuccess: 'Thank you for your blessing! Sign-in successful!', toastError: 'Please fill in all fields.', aiButton: 'Generate with AI', aiLoading: 'Generating...', toastAiError: 'AI blessing generation failed. Please try again later.', geminiPrompt: (title) => `You are a distinguished guest attending the "${title}" event. Please write a short, sincere, and positive blessing in elegant English, within 50 characters.`, }
            };
            
            let guests = [];
            let currentLang = 'zh-Hant';

            function setLanguage(lang) {
                currentLang = lang;
                document.documentElement.lang = lang === 'zh-Hant' ? 'zh-Hant' : 'en';
                const langStrings = translations[lang];
                document.querySelectorAll('[data-lang-key]').forEach(el => {
                    const key = el.dataset.langKey;
                    if (langStrings[key]) el.textContent = langStrings[key];
                });
                elements.eventTitle.textContent = langStrings.eventTitleDefault;
                elements.langZhBtn.classList.toggle('active', lang === 'zh-Hant');
                elements.langEnBtn.classList.toggle('active', lang === 'en');
            }
            
            function createLanterns() { for (let i = 0; i < 10; i++) { const lantern = document.createElement('div'); const sizeClass = ['small', 'medium', 'large'][Math.floor(Math.random() * 3)]; lantern.className = `lantern ${sizeClass}`; lantern.style.left = `${Math.random() * 100}vw`; lantern.style.animationDuration = `${Math.random() * 15 + 15}s`; lantern.style.animationDelay = `${Math.random() * 20}s`; elements.lanternContainer.appendChild(lantern); } }

            function init() {
                setLanguage(currentLang);
                createLanterns();
                switchView('display');
                
                const guestsCollection = collection(db, "guests");
                onSnapshot(guestsCollection, (snapshot) => {
                    guests = []; 
                    snapshot.forEach((doc) => { guests.push(doc.data()); });
                    guests.sort((a, b) => a.timestamp - b.timestamp);
                    updateBlessingMarquee();
                });

                elements.showInputBtn.addEventListener('click', () => switchView('input'));
                elements.showDisplayBtn.addEventListener('click', () => switchView('display'));
                elements.langZhBtn.addEventListener('click', () => setLanguage('zh-Hant'));
                elements.langEnBtn.addEventListener('click', () => setLanguage('en'));
                elements.guestForm.addEventListener('submit', handleFormSubmit);
                elements.generateBlessingBtn.addEventListener('click', handleGenerateBlessing);
            }
            
            function switchView(view) {
                elements.inputSection.classList.toggle('hidden', view !== 'input');
                elements.displaySection.classList.toggle('hidden', view !== 'display');
                elements.showInputBtn.classList.toggle('active', view === 'input');
                elements.showDisplayBtn.classList.toggle('active', view === 'display');
            }

            async function sendDataToGoogleSheet(guestData) {
                const googleAppScriptUrl = "https://script.google.com/macros/s/AKfycbw3YFmhCQEIuQ4mHQ7egzftETvSxVwvCrKnBRauoUNJ7wjgUUXqqcg8H6GZ4dWR24tZ/exec";
                const payload = {
                    name: guestData.name,
                    organization: guestData.organization,
                    title: guestData.title,
                    blessing: guestData.blessing
                };
                try {
                    await fetch(googleAppScriptUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                        body: JSON.stringify(payload)
                    });
                } catch (error) {
                    console.error('Failed to send data to Google Sheet:', error);
                }
            }

            async function handleFormSubmit(e) {
                e.preventDefault();
                const formData = new FormData(elements.guestForm);
                const newGuestData = { name: formData.get('name').trim(), organization: formData.get('organization').trim(), title: formData.get('title').trim(), blessing: formData.get('blessing').trim() };
                
                if (newGuestData.name && newGuestData.organization && newGuestData.title && newGuestData.blessing) {
                    try {
                        // 1. 寫入 Firebase (加上 server timestamp)
                        const guestForFirebase = { ...newGuestData, timestamp: serverTimestamp() };
                        await addDoc(collection(db, "guests"), guestForFirebase);
                        
                        // 2. 同時傳送到 Google Sheet (不含 timestamp)
                        sendDataToGoogleSheet(newGuestData);

                        elements.guestForm.reset();
                        showToast(translations[currentLang].toastSuccess);
                        switchView('display');
                    } catch (error) { 
                        console.error("Error adding document: ", error); 
                        alert("資料寫入失敗，請檢查網路連線或聯繫管理員。"); 
                    }
                } else { 
                    showToast(translations[currentLang].toastError, 'error'); 
                }
            }
            
            function updateBlessingMarquee() {
                if (guests.length > 0) {
                    elements.blessingPlaceholder.style.display = 'none';
                    elements.marqueeContents.forEach(mc => mc.innerHTML = '');
                    const marqueeGuests = [[], [], [], []];
                    guests.forEach((guest, index) => marqueeGuests[index % 4].push(guest));
                    marqueeGuests.forEach((rowGuests, index) => {
                        if (rowGuests.length > 0) {
                            const content = rowGuests.map(g => `<div class="blessing-item">“${g.blessing}”<span class="name">- ${g.name}</span><span class="details">(${g.organization} ${g.title})</span></div>`).join('');
                            const marqueeElement = elements. marqueeContents[index];
                            marqueeElement.innerHTML = content;
                            const duration = (rowGuests.length * (35 + [0, -4, 3, -2][index]));
                            marqueeElement.style.animation = `marquee ${Math.max(duration, 40)}s linear infinite`;
                        }
                    });
                } else { elements.blessingPlaceholder.style.display = 'flex'; }
            }
            
            async function handleGenerateBlessing() {
                const eventTitle = elements.eventTitle.textContent;
                const prompt = translations[currentLang].geminiPrompt(eventTitle);
                elements.blessingLoader.classList.remove('hidden');
                elements.generateBlessingBtn.disabled = true;
                try {
                    const generatedBlessing = await callGeminiAPI(prompt);
                    elements.blessingTextarea.value = generatedBlessing.replace(/["“”]/g, '');
                } catch (error) {
                    console.error('Error calling Gemini API:', error);
                    showToast(translations[currentLang].toastAiError, 'error');
                } finally {
                    elements.blessingLoader.classList.add('hidden');
                    elements.generateBlessingBtn.disabled = false;
                }
            }
            
            async function callGeminiAPI(prompt) {
                const apiKey = "AIzaSyDtzxkOT7VZLq8uhPZMbiZgbRLv-uj_hl4";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const payload = { contents: [{ parts: [{ text: prompt }] }] };
                let retries = 3, delay = 1000;
                while(retries > 0) {
                    try {
                        const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        const result = await response.json();
                        const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                        if (text) return text;
                        throw new Error('Invalid response structure from Gemini API');
                    } catch (error) {
                        console.error(`Attempt failed: ${error.message}`);
                        retries--;
                        if (retries === 0) throw new Error('Max retries reached.');
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                    }
                }
            }

            function showToast(message, type = 'success') {
                elements.toast.textContent = message;
                elements.toast.className = `fixed bottom-10 right-10 text-white py-3 px-6 rounded-lg shadow-xl text-lg transition-all duration-500 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
                elements.toast.classList.remove('opacity-0', 'translate-y-5');
                setTimeout(() => elements.toast.classList.add('opacity-0', 'translate-y-5'), 3000);
            }

            init();
        });
    </script>
</body>
</html>

